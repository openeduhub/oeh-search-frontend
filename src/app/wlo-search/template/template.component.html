<div
  class="reloading-indicator"
  [class.light-bg]="requestInProgress"
  *ngIf="!pageConfigCheckFailed && (!initialLoadSuccessfully || requestInProgress)"
>
  <!-- for requestInProgress the page might be too large to display a visible spinner -->
  <es-spinner *ngIf="!initialLoadSuccessfully"></es-spinner>
</div>
<ng-container *ngIf="!pageConfigCheckFailed; else pageConfigCheckFailedMessage">
  <!-- TOPIC HERO HEADER -->
  <header class="template-header">
    <div class="template-header-wrapper">
      <div class="template-header-container">
        <wlo-topic-header
          [contextNodeId]="topicCollectionID()"
          [defaultNodeId]="defaultTopicTextNodeId"
          [topic]="topic()"
        ></wlo-topic-header>
      </div>
    </div>
  </header>

  <!-- LEFT SIDE MENU WITH ACTION BUTTONS -->
  <wlo-side-menu-wrapper position="left">
    <ng-container slot="menu">
      <wlo-side-menu-item
        [attr.aria-label]="editMode ? 'Switch into preview mode' : 'Switch into edit mode'"
        color="primary"
        position="left"
        [title]="editMode ? actionItems.previewMode : actionItems.editMode"
        (itemClicked)="editMode = !editMode"
      ></wlo-side-menu-item>
    </ng-container>
  </wlo-side-menu-wrapper>

  <!-- RIGHT SIDE MENU WITH MULTIPLE COLLAPSIBLE ITEMS -->
  <wlo-side-menu-wrapper
    [selectedMenuItem]="selectedMenuItem"
    (closeContentView)="selectedMenuItem = ''"
  >
    <ng-container slot="menu">
      <wlo-side-menu-item
        [icon]="'person'"
        [selectedMenuItem]="selectedMenuItem"
        [title]="menuItems.profiling"
        (itemClicked)="collapsibleItemClicked($event)"
      ></wlo-side-menu-item>
      <wlo-side-menu-item
        [selectedMenuItem]="selectedMenuItem"
        [title]="menuItems.topicTree"
        (itemClicked)="collapsibleItemClicked($event)"
      ></wlo-side-menu-item>
      <wlo-side-menu-item
        [selectedMenuItem]="selectedMenuItem"
        [title]="menuItems.statistics"
        (itemClicked)="collapsibleItemClicked($event)"
      ></wlo-side-menu-item>
      <wlo-side-menu-item
        [selectedMenuItem]="selectedMenuItem"
        [title]="menuItems.feedback"
        (itemClicked)="collapsibleItemClicked($event)"
      ></wlo-side-menu-item>
    </ng-container>
    <ng-container slot="content">
      <ng-container *ngIf="selectedMenuItem === menuItems.profiling">
        <h2 class="side-menu-header">Wer bist du?</h2>
        <wlo-filter-bar
          alignment="vertical"
          [requestInProgress]="requestInProgress"
          [manualApplyAndResetButtons]="true"
          [metadataSetName]="defaultMds"
          [selectDimensionKeysOfInterest]="profilingFilterbarDimensionKeys"
          [viewModes]="['radio', 'checkbox']"
          (selectDimensionsChanged)="selectDimensionsChanged($event)"
          (selectValuesChanged)="selectValuesChanged($event)"
        ></wlo-filter-bar>
      </ng-container>
      <ng-container *ngIf="selectedMenuItem === menuItems.topicTree">
        <h2 class="side-menu-header">Themenbaum von {{ topic() }}</h2>
        <wlo-topics-column-browser
          *ngIf="topicCollectionID(); else loadingIndicator"
          [contextNodeId]="topicCollectionID()"
          [customUrl]="retrieveCustomUrl"
          [defaultNodeId]="defaultTopicsColumnBrowserNodeId"
          [height]="'400'"
        ></wlo-topics-column-browser>
      </ng-container>
      <ng-container *ngIf="selectedMenuItem === menuItems.statistics">
        <h2 class="side-menu-header">Inhalte von {{ topic() }}</h2>
        <wlo-statistics-summary
          *ngIf="statisticsLoaded; else loadingIndicator"
          [searchResultCount]="searchResultCount"
          [searchUrl]="searchUrl"
          [statistics]="statistics"
          [topic]="topic()"
        ></wlo-statistics-summary>
      </ng-container>
      <ng-container *ngIf="selectedMenuItem === menuItems.feedback">
        Inhalt von {{ menuItems.feedback }} folgt.
      </ng-container>
      <ng-template #loadingIndicator>
        <es-spinner></es-spinner>
      </ng-template>
    </ng-container>
  </wlo-side-menu-wrapper>

  <!-- FILTER BAR -->
  <div
    class="variable-select-bar fachportal-filterbar"
    [class.reserve-space-left]="userHasEditRights()"
  >
    <div class="fachportal-filterbar-content">
      <wlo-filter-bar
        alignment="horizontal"
        [requestInProgress]="requestInProgress"
        [metadataSetName]="defaultMds"
        [viewModes]="['select']"
        [selectDimensionKeysOfInterest]="verticalFilterbarDimensionKeys"
        (selectDimensionsChanged)="selectDimensionsChanged($event)"
        (selectValuesChanged)="selectValuesChanged($event)"
      ></wlo-filter-bar>
    </div>
  </div>

  <hr />
  <div class="portal-outer-wrapper" [class.reserve-space-left]="userHasEditRights()">
    <div class="portal-wrapper">
      <div class="portal-wrapper-left">
        <ng-container *ngIf="swimlanes.length > 0; else noSwimlanesCreatedYet">
          <!-- note: do not show empty swimlanes to users -->
          <ng-container *ngFor="let swimlane of swimlanes; let i = index">
            <div
              *ngIf="swimlane.grid?.length > 0 || swimlane.type === 'spacer' || editMode"
              class="wlo-swimlane"
              [class.swimlane-edit-mode]="editMode"
              [style.background-color]="
                swimlane.backgroundColor ? swimlane.backgroundColor : '#f4f4f4'
              "
            >
              <!-- edit privileges -->
              <ng-container *ngIf="userHasEditRights()">
                <!-- border with button to add a swimlane -->
                <app-add-swimlane-border-button
                  [requestInProgress]="requestInProgress"
                  (addSwimlaneTriggered)="addSwimlane($event, i)"
                  *ngIf="editMode"
                ></app-add-swimlane-border-button>
                <!-- special case for last element -->
                <app-add-swimlane-border-button
                  position="bottom"
                  [requestInProgress]="requestInProgress"
                  (addSwimlaneTriggered)="addSwimlane($event, i + 1)"
                  *ngIf="editMode && i === swimlanes.length - 1"
                ></app-add-swimlane-border-button>

                <!-- action buttons for moving -->
                <div class="wlo-move-buttons" *ngIf="editMode">
                  <button
                    [disabled]="i === 0 || requestInProgress"
                    (click)="moveSwimlanePosition(i, i - 1)"
                    aria-label="Move swimlane upwards"
                  >
                    <mat-icon>arrow_upward</mat-icon>
                  </button>
                  <button
                    [disabled]="i === swimlanes.length - 1 || requestInProgress"
                    (click)="moveSwimlanePosition(i, i + 1)"
                    aria-label="Move swimlane downwards"
                  >
                    <mat-icon>arrow_downward</mat-icon>
                  </button>
                </div>
                <!-- action buttons for modifications -->
                <div class="wlo-edit-buttons" *ngIf="editMode">
                  <button
                    *ngIf="swimlane.type !== 'spacer'"
                    [disabled]="requestInProgress"
                    (click)="editSwimlane(swimlane, i)"
                    aria-label="Edit swimlane"
                  >
                    <mat-icon>settings</mat-icon>
                  </button>
                  <button
                    [class.wlo-single-button]="swimlane.type === 'spacer'"
                    [disabled]="requestInProgress"
                    (click)="deleteSwimlane(i)"
                    aria-label="Delete swimlane"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </ng-container>
              <!-- type: collapse -->
              <cdk-accordion class="wlo-accordion" *ngIf="swimlane.type === 'collapse'">
                <cdk-accordion-item
                  #accordionItem="cdkAccordionItem"
                  class="wlo-accordion-item"
                  role="button"
                  tabindex="0"
                  [attr.id]="'accordion-header-' + i"
                  [attr.aria-expanded]="accordionItem.expanded"
                  [attr.aria-controls]="'accordion-body-' + i"
                  expanded="true"
                >
                  <div class="wlo-accordion-item-header" (click)="accordionItem.toggle()">
                    <h2>{{ swimlane.heading ?? 'Accordion Header' }}</h2>
                    <span class="wlo-accordion-item-description">
                      <mat-icon *ngIf="accordionItem.expanded">expand_less</mat-icon>
                      <mat-icon *ngIf="!accordionItem.expanded">expand_more</mat-icon>
                    </span>
                  </div>
                  <div
                    class="wlo-accordion-item-body"
                    role="region"
                    [style.display]="accordionItem.expanded ? '' : 'none'"
                    [attr.id]="'accordion-body-' + i"
                    [attr.aria-labelledby]="'accordion-header-' + i"
                  >
                    <p class="wlo-description" *ngIf="swimlane.description">
                      {{ swimlane.description }}
                    </p>
                    <app-swimlane
                      [backgroundColor]="swimlane.backgroundColor"
                      [contextNodeId]="topicCollectionID()"
                      [editMode]="editMode"
                      [filterBarReady]="filterBarReady"
                      [grid]="swimlane.grid"
                      [gridType]="swimlane.gridType"
                      [pageVariantNode]="pageVariantNode"
                      [selectDimensions]="selectDimensions"
                      [selectedDimensionValues]="selectedDimensionValues"
                      [swimlaneIndex]="i"
                      [topic]="topic()"
                      [topicWidgets]="topicWidgets"
                      (gridTileAdded)="handleAddGridTile($event, i)"
                      (nodeClicked)="handleNodeChange($event)"
                    ></app-swimlane>
                  </div>
                </cdk-accordion-item>
              </cdk-accordion>

              <!-- type: jumbotron, text, container -->
              <div
                [class.wlo-container]="swimlane.type === 'container'"
                [class.wlo-jumbotron]="swimlane.type === 'jumbotron'"
                [class.wlo-text]="swimlane.type === 'text'"
                *ngIf="['container', 'jumbotron', 'text'].includes(swimlane.type)"
              >
                <h2 *ngIf="swimlane.heading">{{ swimlane.heading }}</h2>
                <p class="wlo-description" *ngIf="swimlane.description">
                  {{ swimlane.description }}
                </p>
                <app-swimlane
                  [backgroundColor]="swimlane.backgroundColor"
                  [contextNodeId]="topicCollectionID()"
                  [editMode]="editMode"
                  [filterBarReady]="filterBarReady"
                  [grid]="swimlane.grid"
                  [pageVariantNode]="pageVariantNode"
                  [selectDimensions]="selectDimensions"
                  [selectedDimensionValues]="selectedDimensionValues"
                  [swimlaneIndex]="i"
                  [topic]="topic()"
                  [topicWidgets]="topicWidgets"
                  (gridTileAdded)="handleAddGridTile($event, i)"
                  (nodeClicked)="handleNodeChange($event)"
                ></app-swimlane>
              </div>

              <ng-container *ngIf="swimlane.type === 'spacer'">
                <hr class="wlo-spacer" />
              </ng-container>
            </div>
          </ng-container>
        </ng-container>
        <ng-template #noSwimlanesCreatedYet>
          <p class="no-swimlanes">Bisher wurden noch keine Swimlanes mit Inhalten erstellt.</p>
        </ng-template>
      </div>
      <app-preview-panel (dialogClosed)="handleNodeChange(null)"></app-preview-panel>
    </div>
  </div>
</ng-container>

<!-- failed to load page config -> currently, no further action possible -->
<ng-template #pageConfigCheckFailedMessage>
  <p class="no-page-config">
    <strong>Hinweis:</strong>
    Für diese Seite konnte keine Seiten-Konfiguration gefunden werden. Bitte wenden Sie sich an
    Ihren Systemadministrator.
  </p>
</ng-template>
